name: Build and Deploy Sushinja (Self-Hosted)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Docker Image
        run: |
          docker build -t sushinja:latest \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=${{ github.sha }} \
            .

      - name: Stop and Remove Old Containers
        run: |
          # Stop all running containers on port 80
          CONTAINERS=$(docker ps -q --filter "publish=80")
          if [ ! -z "$CONTAINERS" ]; then
            echo "Stopping containers using port 80: $CONTAINERS"
            docker stop $CONTAINERS || true
            docker rm $CONTAINERS || true
          fi
          
          # Also stop by name if it exists
          docker stop sushinja-web 2>/dev/null || true
          docker rm sushinja-web 2>/dev/null || true
          
          # Double check: kill any process using port 80
          sudo fuser -k 80/tcp || true
          
          # Wait a moment for port to be released
          sleep 2

      - name: Run New Container
        run: |
          docker run -d \
            --name sushinja-web \
            --restart unless-stopped \
            -p 80:80 \
            sushinja:latest

      - name: Cleanup Old Images
        run: |
          docker image prune -f

      - name: Display Deployment Info
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸ³ Container: sushinja-web"
          echo "ğŸ“¦ Image: sushinja:latest"
          echo "ğŸ”— URL: http://$(hostname -I | awk '{print $1}')"
          echo "ğŸ“Š Container status:"
          docker ps --filter name=sushinja-web --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
