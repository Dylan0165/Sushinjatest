name: Build and Deploy Sushinja (Self-Hosted)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Docker Image
        run: |
          docker build -t sushinja:latest \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=${{ github.sha }} \
            .

      - name: Stop and Remove Old Containers
        run: |
          # Stop any container using port 80
          docker ps -q --filter "publish=80" | xargs -r docker stop || true
          docker ps -aq --filter "publish=80" | xargs -r docker rm || true
          
          # Also stop by name if it exists
          docker stop sushinja-web || true
          docker rm sushinja-web || true

      - name: Run New Container
        run: |
          docker run -d \
            --name sushinja-web \
            --restart unless-stopped \
            -p 80:80 \
            sushinja:latest

      - name: Cleanup Old Images
        run: |
          docker image prune -f

      - name: Display Deployment Info
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸ³ Container: sushinja-web"
          echo "ğŸ“¦ Image: sushinja:latest"
          echo "ğŸ”— URL: http://$(hostname -I | awk '{print $1}')"
          echo "ğŸ“Š Container status:"
          docker ps --filter name=sushinja-web --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
